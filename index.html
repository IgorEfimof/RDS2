<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Лотерейный калькулятор с виртуальной клавиатурой</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 900px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: rgba(255, 255, 255, 0.92);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            padding: 25px;
            margin-bottom: 20px;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
        }
        
        h1, h2, h3 {
            color: #1a2a6c;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-top: 10px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .input-group {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #444;
        }
        
        input, select {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            border-color: #1a2a6c;
            outline: none;
            box-shadow: 0 0 0 2px rgba(26, 42, 108, 0.2);
        }
        
        .error {
            color: #d32f2f;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }
        
        button {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            display: block;
            width: 100%;
            margin: 10px 0;
        }
        
        button:hover {
            background: linear-gradient(135deg, #23348e, #d32f2f);
            transform: translateY(-2px);
        }
        
        .secondary-btn {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
        }
        
        .secondary-btn:hover {
            background: linear-gradient(135deg, #66BB6A, #388E3C);
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
        }
        
        .btn-group button {
            flex: 1;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #1a2a6c;
        }
        
        .stat-label {
            font-size: 14px;
            color: #555;
        }
        
        .negative {
            color: #d32f2f;
        }
        
        .positive {
            color: #2E7D32;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background: linear-gradient(135deg, #1a2a6c, #23348e);
            color: white;
            position: sticky;
            top: 0;
        }
        
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        tr:hover {
            background-color: #e3f2fd;
        }
        
        .canvas-container {
            height: 300px;
            margin-top: 20px;
        }
        
        .probability-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .probability-card {
            background: linear-gradient(135deg, #f5f5f5, #e0e0e0);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .prize-table {
            width: 100%;
            margin-top: 20px;
        }
        
        .prize-table th {
            background: linear-gradient(135deg, #b21f1f, #d32f2f);
        }
        
        .highlight {
            animation: highlight 2s ease;
        }
        
        @keyframes highlight {
            0% { background-color: #ffffcc; }
            100% { background-color: transparent; }
        }
        
        .footer {
            text-align: center;
            color: white;
            margin-top: 20px;
            padding: 10px;
            font-size: 14px;
        }
        
        /* Виртуальная клавиатура */
        .keyboard-section {
            margin-bottom: 25px;
        }
        
        .keyboard-title {
            text-align: center;
            margin-bottom: 10px;
            color: #1a2a6c;
            font-weight: 600;
        }
        
        .keyboard {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .keyboard-button {
            padding: 12px 0;
            background: linear-gradient(135deg, #4a6fc5, #1a2a6c);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.2s;
            text-align: center;
        }
        
        .keyboard-button:hover {
            background: linear-gradient(135deg, #5a7fd5, #2a3a9c);
            transform: scale(1.05);
        }
        
        .keyboard-button.selected {
            background: linear-gradient(135deg, #fdbb2d, #f46b45);
            box-shadow: 0 0 0 3px rgba(253, 187, 45, 0.5);
        }
        
        .keyboard-button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .selection-info {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            padding: 10px;
            background-color: #e3f2fd;
            border-radius: 8px;
            font-weight: 600;
        }
        
        .numbers-display {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 40px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .number-badge {
            background: linear-gradient(135deg, #1a2a6c, #23348e);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
        }
        
        .number-badge .remove {
            margin-left: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 18px;
        }
        
        .keyboard-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .keyboard-controls button {
            flex: 1;
            padding: 10px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>Лотерейный калькулятор с виртуальной клавиатурой</h1>
    
    <div class="container">
        <!-- Левая колонка -->
        <div class="left-column">
            <div class="card">
                <h2>Виртуальная клавиатура</h2>
                
                <div class="keyboard-section">
                    <h3 class="keyboard-title">Первая часть (1-19)</h3>
                    <div class="keyboard" id="keyboard-first">
                        <!-- Кнопки 1-19 будут сгенерированы через JS -->
                    </div>
                    <div class="selection-info">
                        <div>Выбрано: <span id="selected-first-count">0</span> из 8</div>
                        <div>Осталось: <span id="remaining-first">8</span></div>
                    </div>
                    <div class="numbers-display" id="selected-first-display">
                        <!-- Выбранные числа будут отображаться здесь -->
                    </div>
                </div>
                
                <div class="keyboard-section">
                    <h3 class="keyboard-title">Вторая часть (1-2)</h3>
                    <div class="keyboard" id="keyboard-second">
                        <!-- Кнопки 1-2 будут сгенерированы через JS -->
                    </div>
                    <div class="selection-info">
                        <div>Выбрано: <span id="selected-second-count">0</span> из 1</div>
                        <div>Осталось: <span id="remaining-second">1</span></div>
                    </div>
                    <div class="numbers-display" id="selected-second-display">
                        <!-- Выбранное число будет отображаться здесь -->
                    </div>
                </div>
                
                <div class="keyboard-controls">
                    <button id="random-btn" class="secondary-btn">Случайные числа</button>
                    <button id="clear-btn">Очистить</button>
                </div>
            </div>
            
            <div class="card">
                <h2>Данные билета</h2>
                <div class="input-group">
                    <label for="ticket-cost">Стоимость билета (₽):</label>
                    <input type="number" id="ticket-cost" placeholder="Введите стоимость" min="1">
                    <div class="error" id="cost-error">Введите положительное число</div>
                </div>
                
                <div class="input-group">
                    <label for="draw-number">Номер тиража:</label>
                    <input type="number" id="draw-number" placeholder="Введите номер тиража" min="1">
                    <div class="error" id="draw-error">Введите номер тиража</div>
                </div>
                
                <div class="input-group">
                    <label for="super-prize">Сумма суперприза (если есть):</label>
                    <input type="number" id="super-prize" placeholder="Введите сумму суперприза" min="0" value="0">
                </div>
                
                <button id="add-stats">Добавить данные</button>
                <button id="reset-stats" class="secondary-btn">Сбросить статистику</button>
            </div>
            
            <div class="card">
                <h2>Таблица призов</h2>
                <table class="prize-table">
                    <thead>
                        <tr>
                            <th>1-я часть</th>
                            <th>2-я часть</th>
                            <th>Выигрыш</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>8</td><td>1</td><td>Суперприз</td></tr>
                        <tr><td>8</td><td>0</td><td>25 000 ₽</td></tr>
                        <tr><td>7</td><td>1</td><td>5 000 ₽</td></tr>
                        <tr><td>7</td><td>0</td><td>1 000 ₽</td></tr>
                        <tr><td>6</td><td>1</td><td>175 ₽</td></tr>
                        <tr><td>6</td><td>0</td><td>150 ₽</td></tr>
                        <tr><td>5</td><td>1</td><td>100 ₽</td></tr>
                        <tr><td>5</td><td>0</td><td>50 ₽</td></tr>
                        <tr><td>4</td><td>1</td><td>25 ₽</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Правая колонка -->
        <div class="right-column">
            <div class="card">
                <h2>Основная статистика</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Билетов куплено</div>
                        <div class="stat-value" id="tickets-count">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Потрачено (₽)</div>
                        <div class="stat-value" id="total-spent">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Выиграно (₽)</div>
                        <div class="stat-value" id="total-won">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Баланс (₽)</div>
                        <div class="stat-value" id="balance">0</div>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Средний выигрыш</div>
                        <div class="stat-value" id="avg-win">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Макс. выигрыш</div>
                        <div class="stat-value" id="max-win">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Билетов до безубытка</div>
                        <div class="stat-value" id="break-even-tickets">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Сумма до безубытка</div>
                        <div class="stat-value" id="break-even">0</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2>График баланса</h2>
                <div class="canvas-container">
                    <canvas id="balance-chart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <h2>История операций</h2>
                <div class="btn-group">
                    <button id="export-csv">Экспорт в CSV</button>
                    <button id="clear-history" class="secondary-btn">Очистить историю</button>
                </div>
                <div style="max-height: 400px; overflow-y: auto;">
                    <table id="stats-history">
                        <thead>
                            <tr>
                                <th>№</th>
                                <th>Тираж</th>
                                <th>Стоимость</th>
                                <th>1 часть</th>
                                <th>2 часть</th>
                                <th>Выигрыш</th>
                                <th>Баланс</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Данные будут добавляться сюда -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="card">
                <h2>Вероятности и ожидания</h2>
                <div class="probability-grid">
                    <div class="probability-card">
                        <div class="stat-label">Вероятность выигрыша</div>
                        <div class="stat-value" id="win-probability">0.00%</div>
                    </div>
                    <div class="probability-card">
                        <div class="stat-label">Мат. ожидание</div>
                        <div class="stat-value" id="expected-value">0 ₽</div>
                    </div>
                    <div class="probability-card">
                        <div class="stat-label">Вер. суперприза</div>
                        <div class="stat-value" id="super-probability">0.00001%</div>
                    </div>
                    <div class="probability-card">
                        <div class="stat-label">ROI</div>
                        <div class="stat-value" id="roi">0.00%</div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <h3>Расчет вероятности безубытка</h3>
                    <p>Для покрытия текущего проигрыша в размере <span id="current-loss">0</span> ₽ с вероятностью 50% потребуется купить около <span id="prob-tickets">0</span> билетов.</p>
                    <p>С вероятностью 90% потребуется около <span id="prob-tickets-90">0</span> билетов.</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="footer">
        Лотерейный калькулятор &copy; 2023 | Данные сохраняются в вашем браузере
    </div>

    <script>
        // Объект с призами
        const PRIZES = {
            '8-1': {name: 'Суперприз', amount: 0},
            '8-0': {name: '25 000 ₽', amount: 25000},
            '7-1': {name: '5 000 ₽', amount: 5000},
            '7-0': {name: '1 000 ₽', amount: 1000},
            '6-1': {name: '175 ₽', amount: 175},
            '6-0': {name: '150 ₽', amount: 150},
            '5-1': {name: '100 ₽', amount: 100},
            '5-0': {name: '50 ₽', amount: 50},
            '4-1': {name: '25 ₽', amount: 25},
            'default': {name: 'Не выиграл', amount: 0}
        };
        
        // Теоретические вероятности выигрышей (примерные)
        const PROBABILITIES = {
            '8-1': 0.0000001,
            '8-0': 0.0000005,
            '7-1': 0.00001,
            '7-0': 0.00005,
            '6-1': 0.0005,
            '6-0': 0.001,
            '5-1': 0.005,
            '5-0': 0.01,
            '4-1': 0.05,
            'default': 0.9334
        };
        
        // Инициализация статистики
        let stats = {
            ticketsCount: 0,
            totalSpent: 0,
            totalWon: 0,
            history: [],
            maxWin: 0
        };
        
        // Инициализация Chart.js
        let balanceChart;
        const ctx = document.getElementById('balance-chart').getContext('2d');
        
        // DOM элементы
        const ticketsCountEl = document.getElementById('tickets-count');
        const totalSpentEl = document.getElementById('total-spent');
        const totalWonEl = document.getElementById('total-won');
        const balanceEl = document.getElementById('balance');
        const breakEvenTicketsEl = document.getElementById('break-even-tickets');
        const breakEvenEl = document.getElementById('break-even');
        const avgWinEl = document.getElementById('avg-win');
        const maxWinEl = document.getElementById('max-win');
        const statsHistoryEl = document.getElementById('stats-history').querySelector('tbody');
        const winProbabilityEl = document.getElementById('win-probability');
        const expectedValueEl = document.getElementById('expected-value');
        const superProbabilityEl = document.getElementById('super-probability');
        const roiEl = document.getElementById('roi');
        const currentLossEl = document.getElementById('current-loss');
        const probTicketsEl = document.getElementById('prob-tickets');
        const probTickets90El = document.getElementById('prob-tickets-90');
        
        // Данные для виртуальной клавиатуры
        let selectedFirstNumbers = [];
        let selectedSecondNumbers = [];
        
        // Инициализация виртуальной клавиатуры
        function initKeyboards() {
            const keyboardFirst = document.getElementById('keyboard-first');
            const keyboardSecond = document.getElementById('keyboard-second');
            
            // Создание кнопок для первой части (1-19)
            for (let i = 1; i <= 19; i++) {
                const button = document.createElement('button');
                button.className = 'keyboard-button';
                button.textContent = i;
                button.dataset.number = i;
                button.addEventListener('click', () => toggleFirstNumber(i));
                keyboardFirst.appendChild(button);
            }
            
            // Создание кнопок для второй части (1-2)
            for (let i = 1; i <= 2; i++) {
                const button = document.createElement('button');
                button.className = 'keyboard-button';
                button.textContent = i;
                button.dataset.number = i;
                button.addEventListener('click', () => toggleSecondNumber(i));
                keyboardSecond.appendChild(button);
            }
            
            // Обновляем отображение выбранных чисел
            updateSelectedNumbersDisplay();
        }
        
        // Переключение числа в первой части
        function toggleFirstNumber(number) {
            const index = selectedFirstNumbers.indexOf(number);
            
            if (index > -1) {
                // Если число уже выбрано, удаляем его
                selectedFirstNumbers.splice(index, 1);
            } else {
                // Если выбрано уже 8 чисел, удаляем первое выбранное
                if (selectedFirstNumbers.length >= 8) {
                    selectedFirstNumbers.shift();
                }
                // Добавляем новое число
                selectedFirstNumbers.push(number);
            }
            
            updateSelectedNumbersDisplay();
        }
        
        // Переключение числа во второй части
        function toggleSecondNumber(number) {
            const index = selectedSecondNumbers.indexOf(number);
            
            if (index > -1) {
                // Если число уже выбрано, удаляем его
                selectedSecondNumbers.splice(index, 1);
            } else {
                // Если выбрано уже 1 число, удаляем его
                if (selectedSecondNumbers.length >= 1) {
                    selectedSecondNumbers = [];
                }
                // Добавляем новое число
                selectedSecondNumbers.push(number);
            }
            
            updateSelectedNumbersDisplay();
        }
        
        // Обновление отображения выбранных чисел
        function updateSelectedNumbersDisplay() {
            const firstDisplay = document.getElementById('selected-first-display');
            const secondDisplay = document.getElementById('selected-second-display');
            
            // Обновляем счетчики
            document.getElementById('selected-first-count').textContent = selectedFirstNumbers.length;
            document.getElementById('selected-second-count').textContent = selectedSecondNumbers.length;
            document.getElementById('remaining-first').textContent = 8 - selectedFirstNumbers.length;
            document.getElementById('remaining-second').textContent = 1 - selectedSecondNumbers.length;
            
            // Очищаем отображение
            firstDisplay.innerHTML = '';
            secondDisplay.innerHTML = '';
            
            // Отображаем выбранные числа для первой части
            selectedFirstNumbers.forEach(num => {
                const badge = document.createElement('div');
                badge.className = 'number-badge';
                badge.innerHTML = `${num} <span class="remove" onclick="removeFirstNumber(${num})">×</span>`;
                firstDisplay.appendChild(badge);
            });
            
            // Отображаем выбранные числа для второй части
            selectedSecondNumbers.forEach(num => {
                const badge = document.createElement('div');
                badge.className = 'number-badge';
                badge.innerHTML = `${num} <span class="remove" onclick="removeSecondNumber(${num})">×</span>`;
                secondDisplay.appendChild(badge);
            });
            
            // Обновляем состояние кнопок клавиатуры
            updateKeyboardButtons();
        }
        
        // Удаление числа из первой части
        function removeFirstNumber(number) {
            const index = selectedFirstNumbers.indexOf(number);
            if (index > -1) {
                selectedFirstNumbers.splice(index, 1);
                updateSelectedNumbersDisplay();
            }
        }
        
        // Удаление числа из второй части
        function removeSecondNumber(number) {
            const index = selectedSecondNumbers.indexOf(number);
            if (index > -1) {
                selectedSecondNumbers.splice(index, 1);
                updateSelectedNumbersDisplay();
            }
        }
        
        // Обновление состояния кнопок клавиатуры
        function updateKeyboardButtons() {
            // Обновляем кнопки первой части
            const firstButtons = document.querySelectorAll('#keyboard-first .keyboard-button');
            firstButtons.forEach(button => {
                const num = parseInt(button.dataset.number);
                if (selectedFirstNumbers.includes(num)) {
                    button.classList.add('selected');
                } else {
                    button.classList.remove('selected');
                }
                
                // Отключаем кнопки, если уже выбрано 8 чисел
                if (selectedFirstNumbers.length >= 8 && !selectedFirstNumbers.includes(num)) {
                    button.classList.add('disabled');
                } else {
                    button.classList.remove('disabled');
                }
            });
            
            // Обновляем кнопки второй части
            const secondButtons = document.querySelectorAll('#keyboard-second .keyboard-button');
            secondButtons.forEach(button => {
                const num = parseInt(button.dataset.number);
                if (selectedSecondNumbers.includes(num)) {
                    button.classList.add('selected');
                } else {
                    button.classList.remove('selected');
                }
                
                // Отключаем кнопки, если уже выбрано 1 число
                if (selectedSecondNumbers.length >= 1 && !selectedSecondNumbers.includes(num)) {
                    button.classList.add('disabled');
                } else {
                    button.classList.remove('disabled');
                }
            });
        }
        
        // Генерация случайных чисел
        function generateRandomNumbers() {
            // Генерируем 8 уникальных случайных чисел для первой части (1-19)
            selectedFirstNumbers = [];
            while (selectedFirstNumbers.length < 8) {
                const randomNum = Math.floor(Math.random() * 19) + 1;
                if (!selectedFirstNumbers.includes(randomNum)) {
                    selectedFirstNumbers.push(randomNum);
                }
            }
            
            // Генерируем 1 случайное число для второй части (1-2)
            selectedSecondNumbers = [Math.floor(Math.random() * 2) + 1];
            
            updateSelectedNumbersDisplay();
        }
        
        // Очистка всех выбранных чисел
        function clearAllNumbers() {
            selectedFirstNumbers = [];
            selectedSecondNumbers = [];
            updateSelectedNumbersDisplay();
        }
        
        // Загрузка данных из localStorage
        function loadStats() {
            const savedStats = localStorage.getItem('lotteryStats');
            if (savedStats) {
                stats = JSON.parse(savedStats);
                updateStats();
                renderHistory();
                updateChart();
            }
        }
        
        // Сохранение данных в localStorage
        function saveStats() {
            localStorage.setItem('lotteryStats', JSON.stringify(stats));
        }
        
        // Расчет выигрыша
        function calculateWin(first, second) {
            const key = `${first}-${second}`;
            const prize = PRIZES[key] || PRIZES['default'];
            
            // Если суперприз, используем значение из поля ввода
            if (key === '8-1') {
                const superPrize = Number(document.getElementById('super-prize').value) || 0;
                return {
                    name: 'Суперприз',
                    amount: superPrize
                };
            }
            
            return prize;
        }
        
        // Обновление статистики
        function updateStats() {
            ticketsCountEl.textContent = stats.ticketsCount;
            totalSpentEl.textContent = stats.totalSpent.toLocaleString('ru-RU');
            totalWonEl.textContent = stats.totalWon.toLocaleString('ru-RU');
            
            const balance = stats.totalWon - stats.totalSpent;
            balanceEl.textContent = balance.toLocaleString('ru-RU');
            
            // Обновление классов для цвета баланса
            balanceEl.className = 'stat-value ' + (balance >= 0 ? 'positive' : 'negative');
            
            // Расчет среднего выигрыша
            const avgWin = stats.ticketsCount > 0 ? stats.totalWon / stats.ticketsCount : 0;
            avgWinEl.textContent = avgWin.toLocaleString('ru-RU', {maximumFractionDigits: 2});
            
            // Расчет для покрытия проигрыша
            if (balance < 0) {
                const avgTicketCost = stats.ticketsCount > 0 ? stats.totalSpent / stats.ticketsCount : 0;
                const breakEvenTickets = Math.ceil(-balance / avgTicketCost);
                const breakEvenAmount = breakEvenTickets * avgTicketCost;
                
                breakEvenTicketsEl.textContent = breakEvenTickets;
                breakEvenEl.textContent = breakEvenAmount.toLocaleString('ru-RU', {maximumFractionDigits: 2});
            } else {
                breakEvenTicketsEl.textContent = '0';
                breakEvenEl.textContent = '0';
            }
            
            // Обновление максимального выигрыша
            maxWinEl.textContent = stats.maxWin.toLocaleString('ru-RU');
            
            // Расчет вероятностей
            calculateProbabilities();
            
            // Сохранение статистики
            saveStats();
        }
        
        // Расчет вероятностей
        function calculateProbabilities() {
            // Вероятность любого выигрыша
            let winProbability = 0;
            for (const key in PROBABILITIES) {
                if (key !== 'default') {
                    winProbability += PROBABILITIES[key];
                }
            }
            winProbabilityEl.textContent = (winProbability * 100).toFixed(2) + '%';
            
            // Математическое ожидание выигрыша
            let expectedValue = 0;
            for (const key in PROBABILITIES) {
                const prizeAmount = key === '8-1' ? (Number(document.getElementById('super-prize').value) || 0) : 
                               (PRIZES[key] ? PRIZES[key].amount : 0);
                expectedValue += PROBABILITIES[key] * prizeAmount;
            }
            expectedValueEl.textContent = expectedValue.toLocaleString('ru-RU', {maximumFractionDigits: 2}) + ' ₽';
            
            // Вероятность суперприза
            superProbabilityEl.textContent = (PROBABILITIES['8-1'] * 100).toFixed(5) + '%';
            
            // ROI (Return on Investment)
            const roi = stats.ticketsCount > 0 ? ((stats.totalWon - stats.totalSpent) / stats.totalSpent) * 100 : 0;
            roiEl.textContent = roi.toFixed(2) + '%';
            
            // Вероятностный расчет для покрытия проигрыша
            const balance = stats.totalWon - stats.totalSpent;
            currentLossEl.textContent = (-balance).toLocaleString('ru-RU');
            
            if (balance < 0) {
                const avgTicketCost = stats.ticketsCount > 0 ? stats.totalSpent / stats.ticketsCount : 0;
                const loss = -balance;
                
                // Упрощенный расчет (для демонстрации)
                const tickets50 = Math.ceil(loss / expectedValue);
                const tickets90 = Math.ceil(loss / (expectedValue * 0.5));
                
                probTicketsEl.textContent = tickets50;
                probTickets90El.textContent = tickets90;
            } else {
                probTicketsEl.textContent = '0';
                probTickets90El.textContent = '0';
            }
        }
        
        // Добавление в историю
        function addToHistory(ticket) {
            const row = document.createElement('tr');
            
            // Рассчитываем баланс для этой операции
            const balance = ticket.win.amount - ticket.cost;
            
            row.innerHTML = `
                <td>${stats.ticketsCount}</td>
                <td>${ticket.drawNumber}</td>
                <td>${ticket.cost.toLocaleString('ru-RU')} ₽</td>
                <td>${ticket.first}</td>
                <td>${ticket.second}</td>
                <td>${ticket.win.name} ${ticket.win.amount > 0 ? '(' + ticket.win.amount.toLocaleString('ru-RU') + ' ₽)' : ''}</td>
                <td class="${balance >= 0 ? 'positive' : 'negative'}">${balance.toLocaleString('ru-RU')} ₽</td>
            `;
            
            // Добавляем анимацию для новых записей
            row.classList.add('highlight');
            
            statsHistoryEl.prepend(row);
        }
        
        // Обновление всей истории
        function renderHistory() {
            statsHistoryEl.innerHTML = '';
            
            // Отображаем историю в обратном порядке (последние сверху)
            for (let i = stats.history.length - 1; i >= 0; i--) {
                const ticket = stats.history[i];
                const balance = ticket.win.amount - ticket.cost;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${i + 1}</td>
                    <td>${ticket.drawNumber}</td>
                    <td>${ticket.cost.toLocaleString('ru-RU')} ₽</td>
                    <td>${ticket.first}</td>
                    <td>${ticket.second}</td>
                    <td>${ticket.win.name} ${ticket.win.amount > 0 ? '(' + ticket.win.amount.toLocaleString('ru-RU') + ' ₽)' : ''}</td>
                    <td class="${balance >= 0 ? 'positive' : 'negative'}">${balance.toLocaleString('ru-RU')} ₽</td>
                `;
                statsHistoryEl.appendChild(row);
            }
        }
        
        // Создание/обновление графика
        function updateChart() {
            if (balanceChart) {
                balanceChart.destroy();
            }
            
            // Подготовка данных для графика
            const labels = [];
            const balanceData = [];
            let cumulativeBalance = 0;
            
            for (let i = 0; i < stats.history.length; i++) {
                const ticket = stats.history[i];
                cumulativeBalance += ticket.win.amount - ticket.cost;
                labels.push(`Билет ${i + 1}`);
                balanceData.push(cumulativeBalance);
            }
            
            balanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Баланс (₽)',
                        data: balanceData,
                        borderColor: '#1a2a6c',
                        backgroundColor: 'rgba(26, 42, 108, 0.1)',
                        borderWidth: 3,
                        pointRadius: 3,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }
        
        // Экспорт в CSV
        function exportToCSV() {
            if (stats.history.length === 0) {
                alert('Нет данных для экспорта');
                return;
            }
            
            let csvContent = 'data:text/csv;charset=utf-8,';
            csvContent += '№,Тираж,Стоимость,1 часть,2 часть,Выигрыш,Сумма выигрыша,Баланс\n';
            
            stats.history.forEach((ticket, index) => {
                const balance = ticket.win.amount - ticket.cost;
                const row = [
                    index + 1,
                    ticket.drawNumber,
                    ticket.cost,
                    ticket.first,
                    ticket.second,
                    ticket.win.name,
                    ticket.win.amount,
                    balance
                ].join(',');
                
                csvContent += row + '\n';
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', 'lottery_stats.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Валидация формы
        function validateForm() {
            let isValid = true;
            
            const cost = document.getElementById('ticket-cost').value;
            const drawNumber = document.getElementById('draw-number').value;
            
            // Сброс ошибок
            document.getElementById('cost-error').style.display = 'none';
            document.getElementById('draw-error').style.display = 'none';
            
            // Проверка стоимости
            if (!cost || isNaN(cost) || Number(cost) <= 0) {
                document.getElementById('cost-error').style.display = 'block';
                isValid = false;
            }
            
            // Проверка номера тиража
            if (!drawNumber || isNaN(drawNumber) || Number(drawNumber) <= 0) {
                document.getElementById('draw-error').style.display = 'block';
                isValid = false;
            }
            
            // Проверка выбранных чисел
            if (selectedFirstNumbers.length !== 8) {
                alert('Выберите 8 чисел в первой части!');
                isValid = false;
            }
            
            if (selectedSecondNumbers.length !== 1) {
                alert('Выберите 1 число во второй части!');
                isValid = false;
            }
            
            return isValid;
        }
        
        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', () => {
            // Инициализация клавиатуры
            initKeyboards();
            
            // Загрузка данных
            loadStats();
            
            // Обработчики событий
            document.getElementById('add-stats').addEventListener('click', () => {
                if (!validateForm()) return;
                
                const cost = Number(document.getElementById('ticket-cost').value);
                const drawNumber = document.getElementById('draw-number').value;
                const first = selectedFirstNumbers.join(', ');
                const second = selectedSecondNumbers.join(', ');
                
                const win = calculateWin(selectedFirstNumbers.length, selectedSecondNumbers.length);
                
                // Обновление статистики
                stats.ticketsCount++;
                stats.totalSpent += cost;
                stats.totalWon += win.amount;
                
                // Обновление максимального выигрыша
                if (win.amount > stats.maxWin) {
                    stats.maxWin = win.amount;
                }
                
                const ticketData = {
                    cost,
                    drawNumber,
                    first,
                    second,
                    win
                };
                
                stats.history.push(ticketData);
                addToHistory(ticketData);
                updateStats();
                updateChart();
                
                // Очистка полей
                document.getElementById('ticket-cost').value = '';
                document.getElementById('draw-number').value = '';
                document.getElementById('super-prize').value = '0';
                
                // Очистка выбранных чисел
                clearAllNumbers();
            });
            
            document.getElementById('reset-stats').addEventListener('click', () => {
                if (confirm('Вы уверены, что хотите сбросить всю статистику?')) {
                    stats = {
                        ticketsCount: 0,
                        totalSpent: 0,
                        totalWon: 0,
                        history: [],
                        maxWin: 0
                    };
                    
                    localStorage.removeItem('lotteryStats');
                    updateStats();
                    renderHistory();
                    updateChart();
                }
            });
            
            document.getElementById('export-csv').addEventListener('click', exportToCSV);
            
            document.getElementById('clear-history').addEventListener('click', () => {
                if (confirm('Вы уверены, что хотите очистить историю? Данные статистики останутся.')) {
                    stats.history = [];
                    stats.ticketsCount = 0;
                    stats.totalSpent = 0;
                    stats.totalWon = 0;
                    stats.maxWin = 0;
                    saveStats();
                    updateStats();
                    renderHistory();
                    updateChart();
                }
            });
            
            // Обработчики кнопок клавиатуры
            document.getElementById('random-btn').addEventListener('click', generateRandomNumbers);
            document.getElementById('clear-btn').addEventListener('click', clearAllNumbers);
            
            // Инициализация вероятностей
            calculateProbabilities();
        });
        
        // Сделаем функции доступными глобально для обработчиков удаления
        window.removeFirstNumber = removeFirstNumber;
        window.removeSecondNumber = removeSecondNumber;
    </script>
</body>
</html>
